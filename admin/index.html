<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GadgetHut Admin - Update Images</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto mt-10 p-8 bg-white rounded-lg shadow-lg">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">GadgetHut Admin - Update Product Images</h1>
        
        <p class="text-gray-600 mb-4">
            This panel lets you change the image for a product. Go to <a href="https://unsplash.com/" target="_blank" class="text-blue-600 hover:underline">Unsplash</a>, find an image, right-click it, and select "Copy image address". Paste that URL here.
        </p>

        <div id="product-list-admin" class="space-y-6">
            <!-- Product update forms will be loaded here -->
             <p id="loading-admin-products">Loading products...</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="admin-toast" class="hidden fixed bottom-5 right-5 bg-green-500 text-white px-4 py-2 rounded shadow-md">
        Image updated successfully!
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const productListAdminEl = document.getElementById('product-list-admin');
            const loadingAdminProductsEl = document.getElementById('loading-admin-products');
            const adminToastEl = document.getElementById('admin-toast');
            let products = [];

            async function fetchAdminProducts() {
                // Show loading indicator
                if (loadingAdminProductsEl) loadingAdminProductsEl.style.display = 'block';
                productListAdminEl.innerHTML = ''; // Clear previous errors or content

                try {
                    // Use absolute path for fetch
                    const response = await fetch('/gadgethut-store/api/products.php'); // Fetch all products
                     if (!response.ok) {
                         throw new Error(`Network response was not ok (status: ${response.status})`);
                    }
                    const contentType = response.headers.get("content-type");
                     if (!contentType || !contentType.includes("application/json")) {
                         const textResponse = await response.text();
                         throw new Error(`Expected JSON but received: ${contentType}. Response: ${textResponse.substring(0, 100)}...`);
                     }
                    const data = await response.json();
                     if (data.error) { // Check if PHP sent back a JSON error
                        throw new Error(data.error);
                    }

                    products = data;
                    displayAdminProducts(products);
                     if (loadingAdminProductsEl) loadingAdminProductsEl.style.display = 'none'; // Hide loading

                } catch (error) {
                    console.error('Failed to fetch products for admin:', error);
                     if (loadingAdminProductsEl) loadingAdminProductsEl.style.display = 'none'; // Hide loading
                    productListAdminEl.innerHTML = `<p class="text-red-500">Failed to load products: ${error.message}</p>`;
                }
            }

            function displayAdminProducts(products) {
                productListAdminEl.innerHTML = ''; // Clear loading message or previous content
                products.forEach(product => {
                    const formEl = document.createElement('form');
                    formEl.className = 'update-image-form p-4 border rounded-lg bg-gray-50';
                    formEl.dataset.productId = product.id;
                    formEl.innerHTML = `
                        <label class="block text-sm font-medium text-gray-700">Product ID ${product.id}: ${product.name}</label>
                        <div class="mt-2 flex items-center space-x-2">
                             <img src="${product.image_url}" alt="${product.name}" class="w-16 h-16 object-cover rounded mr-2 inline-block" onerror="this.style.display='none'">
                             <label for="image_url_${product.id}" class="block text-sm font-medium text-gray-700 sr-only">New Image URL</label>
                            <input type="url" name="image_url" id="image_url_${product.id}" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="https://images.unsplash.com/..." required>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">
                                Update Image
                            </button>
                        </div>
                    `;
                    productListAdminEl.appendChild(formEl);
                });
            }

            function showAdminToast(message, isSuccess = true) {
                 adminToastEl.textContent = message;
                 adminToastEl.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
                 adminToastEl.classList.add(isSuccess ? 'bg-green-500' : 'bg-red-500');
                
                 // Clear previous timeout if any
                if(adminToastEl.timeoutId) clearTimeout(adminToastEl.timeoutId);
                 adminToastEl.timeoutId = setTimeout(() => {
                     adminToastEl.classList.add('hidden');
                 }, 3000);
            }

            // Event listener for form submissions
            productListAdminEl.addEventListener('submit', async (e) => {
                if (e.target.classList.contains('update-image-form')) {
                    e.preventDefault();
                    const form = e.target;
                    const productId = form.dataset.productId;
                    const imageUrlInput = form.querySelector('input[name="image_url"]');
                    const newImageUrl = imageUrlInput.value;
                    const submitButton = form.querySelector('button[type="submit"]');
                    const originalButtonText = submitButton.textContent;

                    submitButton.textContent = 'Updating...';
                    submitButton.disabled = true;

                    try {
                        // Use absolute path for fetch
                        const response = await fetch('/gadgethut-store/api/update_image.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ product_id: productId, image_url: newImageUrl })
                        });

                        const contentType = response.headers.get("content-type");
                         if (!response.ok || !contentType || !contentType.includes("application/json")) {
                             const textResponse = await response.text();
                             throw new Error(`Server error (${response.status}): ${textResponse.substring(0, 100)}...`);
                         }

                        const result = await response.json();

                        if (result.success) {
                            showAdminToast('Image updated successfully!', true);
                            // Update the image preview in the admin panel
                            const imgPreview = form.querySelector('img');
                            if(imgPreview) imgPreview.src = newImageUrl;
                            imageUrlInput.value = ''; // Clear input
                        } else {
                            throw new Error(result.error || 'Unknown error updating image.');
                        }
                    } catch (error) {
                        console.error('Failed to update image:', error);
                        showAdminToast(`Error: ${error.message}`, false);
                    } finally {
                        submitButton.textContent = originalButtonText;
                        submitButton.disabled = false;
                    }
                }
            });

            // Initial load
            fetchAdminProducts();
        });
    </script>
</body>
</html>

